<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml"  xml:lang="en-gb" lang="en-gb" dir="ltr" >
<head>
  <base href="https://blog-archive.pavlakis.info/9-linux/24-notes-on-setting-up-letsencrypt" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Antonis Pavlakis" />
  <meta name="generator" content="Joomla! - Open Source Content Management" />
  <title>Notes on setting up letsencrypt</title>
  <link href="/templates/beez_20/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />
  <link rel="stylesheet" href="/templates/system/css/system.css" type="text/css" />
  <link rel="stylesheet" href="/templates/beez_20/css/position.css" type="text/css" media="screen,projection"  />
  <link rel="stylesheet" href="/templates/beez_20/css/layout.css" type="text/css" media="screen,projection"  />
  <link rel="stylesheet" href="/templates/beez_20/css/print.css" type="text/css" media="print"  />
  <link rel="stylesheet" href="/templates/beez_20/css/general.css" type="text/css" />
  <link rel="stylesheet" href="/templates/beez_20/css/nature.css" type="text/css" />
  <script src="/media/system/js/mootools-core.js" type="text/javascript"></script>
  <script src="/media/system/js/core.js" type="text/javascript"></script>
  <script src="/media/system/js/caption.js" type="text/javascript"></script>
  <script src="/media/system/js/mootools-more.js" type="text/javascript"></script>
  <script src="/templates/beez_20/javascript/md_stylechanger.js" type="text/javascript"></script>
  <script src="/templates/beez_20/javascript/hide.js" type="text/javascript"></script>
  <script type="text/javascript">
window.addEvent('load', function() {
				new JCaption('img.caption');
			});
  </script>


<!--[if lte IE 6]>
<link href="/templates/beez_20/css/ieonly.css" rel="stylesheet" type="text/css" />
<![endif]-->

<!--[if IE 7]>
<link href="/templates/beez_20/css/ie7only.css" rel="stylesheet" type="text/css" />
<![endif]-->

<script type="text/javascript">
	var big ='72%';
	var small='53%';
	var altopen='is open';
	var altclose='is closed';
	var bildauf='/templates/beez_20/images/plus.png';
	var bildzu='/templates/beez_20/images/minus.png';
	var rightopen='Open info';
	var rightclose='Close info';
	var fontSizeTitle='Font size';
	var bigger='Bigger';
	var reset='Reset';
	var smaller='Smaller';
	var biggerTitle='Increase size';
	var resetTitle='Revert styles to default';
	var smallerTitle='Decrease size';
</script>

</head>

<body>

<div id="all">
        <div id="back">
                <div id="header">
                                <div class="logoheader">
                                        <h1 id="logo">

                                                                                                                        Adventures in Lifelong Development                                                                                <span class="header1">
                                        /pavlakis                                        </span></h1>
                                </div><!-- end logoheader -->
                                        <ul class="skiplinks">
                                                <li><a href="#main" class="u2">Skip to content</a></li>
                                                <li><a href="#nav" class="u2">Jump to main navigation and login</a></li>
                                                                                    </ul>
                                        <h2 class="unseen">Nav view search</h2>
                                        <h3 class="unseen">Navigation</h3>
                                        
<ul class="menu">
<li class="item-101 current active"><a href="/" >Home</a></li><li class="item-102"><a href="/about-antonios-pavlakis" >About Me</a></li><li class="item-103"><a href="/php" >PHP</a></li><li class="item-121"><a href="https://github.com/pavlakis" >GitHub</a></li></ul>

                                        <div id="line">
                                        <div id="fontsize"></div>
                                        <h3 class="unseen">Search</h3>
                                        <form action="/" method="post">
	<div class="search">
		<label for="mod-search-searchword">Search...</label><input name="searchword" id="mod-search-searchword" maxlength="20"  class="inputbox" type="text" size="20" value="Search..."  onblur="if (this.value=='') this.value='Search...';" onfocus="if (this.value=='Search...') this.value='';" />	<input type="hidden" name="task" value="search" />
	<input type="hidden" name="option" value="com_search" />
	<input type="hidden" name="Itemid" value="101" />
	</div>
</form>

                                        </div> <!-- end line -->


                        </div><!-- end header -->
                        <div id="contentarea">
                                        <div id="breadcrumbs">

                                                        

                                        </div>

                                        
                                        <div id="wrapper2" class="shownocolumns">

                                                <div id="main">

                                                
                                                        
<div id="system-message-container">
</div>
                                                        <div class="item-page">

	<h2>
			<a href="/9-linux/24-notes-on-setting-up-letsencrypt">
		Notes on setting up letsencrypt</a>
		</h2>

	<ul class="actions">
						<li class="print-icon">
			<a href="/9-linux/24-notes-on-setting-up-letsencrypt?tmpl=component&amp;print=1&amp;page=" title="Print" onclick="window.open(this.href,'win2','status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,resizable=yes,width=640,height=480,directories=no,location=no'); return false;" rel="nofollow"><img src="/media/system/images/printButton.png" alt="Print"  /></a>			</li>
		
					<li class="email-icon">
			<a href="/component/mailto/?tmpl=component&amp;template=beez_20&amp;link=bd612c4c24fd359b87610c70ba547f2ecad377c2" title="Email" onclick="window.open(this.href,'win2','width=400,height=350,menubar=yes,resizable=yes'); return false;"><img src="/media/system/images/emailButton.png" alt="Email"  /></a>			</li>
		
		
	
	</ul>




	<dl class="article-info">
	<dt class="article-info-term">Details</dt>
	<dd class="create">
	Created on Monday, 28 March 2016 00:32	</dd>
	</dl>



<pInstalling LetsEncrypt is mostly done in 4 simple steps</p>

<pre>
Clone repository
Setup letsencrypt
Generate certificates
Update web server configuration
</pre>

<p>Below are some notes when setting it up in two different systems, in Centos 6.7 with Apache and in Centos 7 with Nginx and Varnish</p>


<h4>Centos 6.7 with Apache </h4>

<pre>
Clone repo
Run: 
Initial setup: ./letsencrypt-auto --help
Generate keys: ./letsencrypt-auto --apache
</pre>

<p>Issues</p>
<p>Checking for new version...<br>
Creating virtual environment...<br>
./letsencrypt-auto: line 455: virtualenv: command not found<br>
</p>
<p>
To fix the above, we need to install the missing dependencies. ( for more info see: <a href="https://geekflare.com/virtualenv-command-not-found-centos6/">https://geekflare.com/virtualenv-command-not-found-centos6/</a>)
</p>

<pre>
yum install centos-release-SCL
yum update
yum install scl-utils python27 python27-scldevel
scl enable python27 bash
</pre>

<p>
Now we should be able to generate the keys by running:<br>
./letsencrypt-auto --apache
</p>

<p>Note: In future key generation we only need to run: <strong>scl enable python27 bash</strong></p>

<p>If the generation has been successful, we should see a message showing where the certificates are stored. By default should be in:</p>

<p>/etc/letsencrypt/live/[your-full-url]/fullchain.pem</p>


<p>So now we can update the Apache vhost with:</p>

<pre>
&lt;VirtualHost *:443&gt;

SSLEngine on
   SSLCertificateFile /etc/letsencrypt/live/blog.pavlakis.info/cert.pem
   SSLCertificateKeyFile /etc/letsencrypt/live/blog.pavlakis.info/privkey.pem
   SSLCertificateChainFile /etc/letsencrypt/live/blog.pavlakis.info/chain.pem

&lt;/VirtualHost&gt;
</pre>



<p>If SSL not configured correctly, the following steps may help:</p>

<ul>
<li>Add the ssl.conf (or equivalent in httpd.conf)</li>
<li>Remove the <VirtualHost> example from ssl.conf</li>
<li>If there are issues with port not accessible, check using: <strong>netstat -nlt</strong></li>
<li>May need to enable in iptables, although might just be that apache is not Listening</li>
<li>Failed to connect to host for DVSNI challenge: Needed to use the full url</li>
</ul>

<p>If getting warning: _default_ VirtualHost overlap on port 443, the first has precedence</p>

<p>Do something like:</p>

<p><strong>conf.d/ssl.conf</strong><br>
NameVirtualHost *:443<br>
Listen 443<br>
</p>

<p>Once that's working, we can set a redirect to 443 from port 80</p>

<pre>
&lt;VirtualHost *:80&gt;

    Redirect / https://blog.pavlakis.info/

&lt;/VirtualHost&gt;
</pre>

<h4>Centos 7 with Nginx and Varnish</h4>

<pre>
Clone repo
Run: 
Initial setup: ./letsencrypt-auto --help
</pre>

<p><strong>./letsencrypt-auto certonly -a webroot --webroot-path=/srv/public -d phpminds.org -d www.phpminds.org</strong></p>

<p>
Under nginx configuration (e.g. /etc/nginx/sites-available/default.conf)<br>
Add a server section for a redirect (note weâ€™re using Varnish):
</p>

<pre>
server {
        listen 8080;

        server_name phpminds.org www.phpminds.org;

        return 301 https://$host$request_uri;
}
</pre>

<p>
And a second server section to include all the other info:<br>
Listen for port 8080 (because weâ€™re using Varnish) and port 443.<br>
Add location with the 443 configuration.
</p>

<pre>
server {

        listen 8080;

        server_name phpminds.org www.phpminds.org;

        listen 443 ssl default;

        ssl_certificate /etc/letsencrypt/live/phpminds.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/phpminds.org/privkey.pem;

â€¦

       location / {
            try_files $uri $uri/ /index.php?$query_string;
            proxy_set_header X-Real-IP  $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Port 443;
            proxy_set_header Host $host;
        }
}
</pre>

<p>
In case SSL not configured correctly, check if web server is listening on port 443.<br>
<strong>netstat -nlt</strong>
</p>

<p>If 443 not showing check web server configuration. Otherwise check if https is accessible internally: <br>
<strong>curl -I https://phpminds.org</strong></p>

<p>If it is accessible internally but not externally, check the firewall:</p>

<p>
iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT<br>
service iptables save<br>
service iptables restart<br>
</p>

<p>OR</p>

<p>
firewall-cmd --add-port=443/tcp<br>
firewall-cmd --permanent --add-port=443/tcp
</p>

<p>
As we are running Varnish, very important to restart both services:
</p>

<p>
systemctl restart nginx.service<br>
systemctl restart varnish.service
</p>

<h4>Certificate Renewals</h4>

<p>Certificates are only valid for 90 days. Checkout Cal Evanâ€™s post on automating the renewal process:<br>
<a href="https://blog.calevans.com/2016/02/22/how-i-got-lets-encrypt-setup-and-operating/">https://blog.calevans.com/2016/02/22/how-i-got-lets-encrypt-setup-and-operating/</a>
</p> 
	
</div>


                                                </div><!-- end main -->

                                        </div><!-- end wrapper -->

                                
                        
                                <div class="wrap"></div>

                                </div> <!-- end contentarea -->

                        </div><!-- back -->

                </div><!-- all -->

                <div id="footer-outer">
                        
                        <div id="footer-sub">


                                <div id="footer">

                                        
                                        <p>
                                                Powered by <a href="http://www.joomla.org/">Joomla!&#174;</a>
                                        </p>


                                </div><!-- end footer -->

                        </div>

                </div>
				
        <div id="fb-root"></div>
<script>
window.fbAsyncInit = function() { FB.init({appId: '485228941509888', status: true, cookie: true, xfbml: true}); };
(function() { var e = document.createElement('script');
e.type = 'text/javascript';
e.src = document.location.protocol + '//connect.facebook.net/en_GB/all.js';
e.async = true;
document.getElementById('fb-root').appendChild(e);
}());
</script></body>
</html>
