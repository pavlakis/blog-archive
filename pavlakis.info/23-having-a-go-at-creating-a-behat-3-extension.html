<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml"  xml:lang="en-gb" lang="en-gb" dir="ltr" >
<head>
  <base href="https://blog-archive.pavlakis.info/php/23-having-a-go-at-creating-a-behat-3-extension" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Antonis Pavlakis" />
  <meta name="generator" content="Joomla! - Open Source Content Management" />
  <title>Having a go at creating a Behat 3 extension</title>
  <link href="/templates/beez_20/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />
  <link rel="stylesheet" href="/templates/system/css/system.css" type="text/css" />
  <link rel="stylesheet" href="/templates/beez_20/css/position.css" type="text/css" media="screen,projection"  />
  <link rel="stylesheet" href="/templates/beez_20/css/layout.css" type="text/css" media="screen,projection"  />
  <link rel="stylesheet" href="/templates/beez_20/css/print.css" type="text/css" media="print"  />
  <link rel="stylesheet" href="/templates/beez_20/css/general.css" type="text/css" />
  <link rel="stylesheet" href="/templates/beez_20/css/nature.css" type="text/css" />
  <script src="/media/system/js/mootools-core.js" type="text/javascript"></script>
  <script src="/media/system/js/core.js" type="text/javascript"></script>
  <script src="/media/system/js/caption.js" type="text/javascript"></script>
  <script src="/media/system/js/mootools-more.js" type="text/javascript"></script>
  <script src="/templates/beez_20/javascript/md_stylechanger.js" type="text/javascript"></script>
  <script src="/templates/beez_20/javascript/hide.js" type="text/javascript"></script>
  <script type="text/javascript">
window.addEvent('load', function() {
				new JCaption('img.caption');
			});
  </script>


<!--[if lte IE 6]>
<link href="/templates/beez_20/css/ieonly.css" rel="stylesheet" type="text/css" />
<![endif]-->

<!--[if IE 7]>
<link href="/templates/beez_20/css/ie7only.css" rel="stylesheet" type="text/css" />
<![endif]-->

<script type="text/javascript">
	var big ='72%';
	var small='53%';
	var altopen='is open';
	var altclose='is closed';
	var bildauf='/templates/beez_20/images/plus.png';
	var bildzu='/templates/beez_20/images/minus.png';
	var rightopen='Open info';
	var rightclose='Close info';
	var fontSizeTitle='Font size';
	var bigger='Bigger';
	var reset='Reset';
	var smaller='Smaller';
	var biggerTitle='Increase size';
	var resetTitle='Revert styles to default';
	var smallerTitle='Decrease size';
</script>

</head>

<body>

<div id="all">
        <div id="back">
                <div id="header">
                                <div class="logoheader">
                                        <h1 id="logo">

                                                                                                                        Adventures in Lifelong Development                                                                                <span class="header1">
                                        /pavlakis                                        </span></h1>
                                </div><!-- end logoheader -->
                                        <ul class="skiplinks">
                                                <li><a href="#main" class="u2">Skip to content</a></li>
                                                <li><a href="#nav" class="u2">Jump to main navigation and login</a></li>
                                                                                    </ul>
                                        <h2 class="unseen">Nav view search</h2>
                                        <h3 class="unseen">Navigation</h3>
                                        
<ul class="menu">
<li class="item-101"><a href="/" >Home</a></li><li class="item-102"><a href="/about-antonios-pavlakis" >About Me</a></li><li class="item-103 current active"><a href="/php" >PHP</a></li><li class="item-121"><a href="https://github.com/pavlakis" >GitHub</a></li></ul>

                                        <div id="line">
                                        <div id="fontsize"></div>
                                        <h3 class="unseen">Search</h3>
                                        <form action="/php" method="post">
	<div class="search">
		<label for="mod-search-searchword">Search...</label><input name="searchword" id="mod-search-searchword" maxlength="20"  class="inputbox" type="text" size="20" value="Search..."  onblur="if (this.value=='') this.value='Search...';" onfocus="if (this.value=='Search...') this.value='';" />	<input type="hidden" name="task" value="search" />
	<input type="hidden" name="option" value="com_search" />
	<input type="hidden" name="Itemid" value="103" />
	</div>
</form>

                                        </div> <!-- end line -->


                        </div><!-- end header -->
                        <div id="contentarea">
                                        <div id="breadcrumbs">

                                                        

                                        </div>

                                        
                                        <div id="wrapper2" class="shownocolumns">

                                                <div id="main">

                                                
                                                        
<div id="system-message-container">
</div>
                                                        <div class="item-page">

	<h2>
			<a href="/php/23-having-a-go-at-creating-a-behat-3-extension">
		Having a go at creating a Behat 3 extension</a>
		</h2>

	<ul class="actions">
						<li class="print-icon">
			<a href="/php/23-having-a-go-at-creating-a-behat-3-extension?tmpl=component&amp;print=1&amp;layout=default&amp;page=" title="Print" onclick="window.open(this.href,'win2','status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,resizable=yes,width=640,height=480,directories=no,location=no'); return false;" rel="nofollow"><img src="/media/system/images/printButton.png" alt="Print"  /></a>			</li>
		
					<li class="email-icon">
			<a href="/component/mailto/?tmpl=component&amp;template=beez_20&amp;link=6c8549c83224ad3d18ed96a633db6b25b8926c49" title="Email" onclick="window.open(this.href,'win2','width=400,height=350,menubar=yes,resizable=yes'); return false;"><img src="/media/system/images/emailButton.png" alt="Email"  /></a>			</li>
		
		
	
	</ul>




	<dl class="article-info">
	<dt class="article-info-term">Details</dt>
	<dd class="create">
	Created on Thursday, 14 January 2016 23:53	</dd>
	</dl>



<p>Ever since I got accepted to do a tutorial on <a href="https://speakerdeck.com/agpavlakis/test-legacy-apps-with-behat">Test legacy apps with Behat</a> at the <a href="http://conference.phpnw.org.uk/phpnw15/">PHPNW15 conference</a>, I’ve been meaning to look into creating custom extensions for <a href="https://github.com/Behat/Behat">Behat</a>.</p>

<p>I didn’t have enough time to research into this while preparing for the tutorial, so left it in my todo list in <a href="https://trello.com/">Trello</a>.</p>

<p>During the PHPNW15 long weekend (Friday - Monday), at some point over lunch I was at the table where Matt Brunt (<a href="https://twitter.com/themattbrunt">@themattbrunt</a>) and Ciaran McNulty (<a href="https://twitter.com/ciaranmcnulty">@ciaranmcnulty</a>) were having a conversation about this and Ciaran said (paraphrasing) “In order to be able to write an extension, you really need to understand how Behat works.”</p>

<p>So a few months later, sleeves up and I went into my <strong>vendor/bin/behat</strong> and started looking (and poking) around.</p>

<p>Behat is a great application. Nice and clean code. And everything happens by magic - well, nearly. :)</p>

<p>But… I won’t be going into that.</p>

<p>I ended up taking a shortcut. I found a great article by its creator Konstantin Kudryashov (https://gist.github.com/everzet/9888598), and spent a lot of time looking into two existing extensions:</p>

<ul>
<li><a href="https://github.com/Behat/MinkExtension">Behat Mink Extension</a></li>
<li><a href="https://github.com/laracasts/Behat-Laravel-Extension">Behat Laravel Extension</a></li>
</ul>

<p>I’ve actually used mostly the structure of the Laravel extension.</p>

<p>The most important thing to keep in mind is that everything is being driven by Interfaces.</p>

<p>Following the structure of the Laravel extension, we have three main folders:</p>
<ul>
<li>Context</li>
<li>Driver (won’t cover this here)</li>
<li>ServiceContainer</li>
</ul>

<h3>ServiceContainer/BehatExtension.php</h3>

<p>This class implements <strong>Behat\Behat\Context\ServiceContainer\ContextExtension</strong>
and requires/implements the following methods:</p>

<ul>
<li><strong>getConfigKey()</strong> - The extension config key</li>
<li><strong>initialize(ExtensionManager $extensionManager)</strong> - used to hook into the configuration of other extensions e.g. Mink</li>
<li><strong>process(ContainerBuilder $container)</strong> -  You can modify the container here before it is dumped to PHP code.</li>
<li><strong>configure(ArrayNodeDefinition $builder)</strong> - Setups configuration for the extension.</li>
<li><strong>load(ContainerBuilder $container, array $config)</strong> - Loads extension services into temporary container.</li>
</ul>

<h4>configure(ArrayNodeDefinition $builder)</h4>

<p>This method enables you to set the configuration for the extension. The parameters you need and their default values.
For the Slim 3 extension, I used the config_file location (settings.php) which together with the dependencies_file is pretty much all I need to load the Slim/App and populate the DI container.</p>

<p>Adding the parameters in behat.yml</p>

<script src="https://gist.github.com/pavlakis/8d3070606fadc45aca03.js"></script>

<p>See the implementation on Github: <a href="https://github.com/pavlakis/slim-behat-extension/blob/master/src/ServiceContainer/BehatExtension.php#L42">https://github.com/pavlakis/slim-behat-extension/blob/master/src/ServiceContainer/BehatExtension.php#L42</a></p>

<h4>load(ContainerBuilder $container, array $config)</h4>

<p>This method lets you pass the configuration to your service in order to load it.</p>

<p>The <strong>$config</strong> array gives you access to extension configuration parameters (in behat.yml) e.g. $config['config_file'] and $config['dependencies_file'] </p>

<p>We can use those values to load our Service through the <strong>$container</strong>.</p>

<p>The ContainerBuilder is used to:</p>
<ul>
<li>Create an instance of the Service and pass it to the builder using $container->set(..) </li>
<li>Add a Definition containing the:<br/>
* The Service and its link to its own extension class implementing ContextInitializer <br/>
* A tag definition for the Service
</li>

<h4>Context/KernelAwareInitializer.php</h4>

<p>This class implements <strong>Behat\Behat\Context\Initializer\ContextInitializer</strong> and requires/implements the following methods:</p>
<strong>initializeContext(Context $context)</strong> - Initializes provided context.

<p>The constructor makes the Service/Kernel available. In the <strong>initializeContext(Context $context)</strong> method we check if the Context passed is an instance of the context we are expecting (in this case Pavlakis\Slim\Behat\Context\KernelAwareContext which also implements Behat\Behat\Context\Context - but it is specific to our extension) and if it is, we add our Service to the Context.</p>

<p><a href="https://github.com/pavlakis/slim-behat-extension/blob/master/src/Context/KernelAwareInitializer.php#L50">https://github.com/pavlakis/slim-behat-extension/blob/master/src/Context/KernelAwareInitializer.php#L50</a></p> 

<h4>Pavlakis\Slim\Behat\Context\App.php (Trait)</h4>

<p>This class is a Trait. And very important.</p>
<p>It makes the app available through the FeatureContext class by just calling <strong>$this->app</strong></p>

<p>To use it, implement <strong>Pavlakis\Slim\Behat\Context\KernelAwareContext</strong></p>

<script src="https://gist.github.com/pavlakis/615ec0db9f4eda5732d2.js"></script>


<p>And that’s it. These are the points that I spent most time on. Hope it helps.</p>

<p>
This extension is available available through packagist: <a href="https://packagist.org/packages/pavlakis/slim-behat-extension">https://packagist.org/packages/pavlakis/slim-behat-extension</a>
<p>
<p>And Github: <br/>
<a href="https://github.com/pavlakis/slim-behat-extension">https://github.com/pavlakis/slim-behat-extension</a>
</p>


 
				<ul class="pagenav">
					<li class="pagenav-next">
						<a href="/php/22-making-a-cli-request-in-slim-3" rel="next">Next &gt;</a>
					</li>
				</ul>
	
</div>


                                                </div><!-- end main -->

                                        </div><!-- end wrapper -->

                                
                        
                                <div class="wrap"></div>

                                </div> <!-- end contentarea -->

                        </div><!-- back -->

                </div><!-- all -->

                <div id="footer-outer">
                        
                        <div id="footer-sub">


                                <div id="footer">

                                        
                                        <p>
                                                Powered by <a href="http://www.joomla.org/">Joomla!&#174;</a>
                                        </p>


                                </div><!-- end footer -->

                        </div>

                </div>
				
        <div id="fb-root"></div>
<script>
window.fbAsyncInit = function() { FB.init({appId: '485228941509888', status: true, cookie: true, xfbml: true}); };
(function() { var e = document.createElement('script');
e.type = 'text/javascript';
e.src = document.location.protocol + '//connect.facebook.net/en_GB/all.js';
e.async = true;
document.getElementById('fb-root').appendChild(e);
}());
</script></body>
</html>
